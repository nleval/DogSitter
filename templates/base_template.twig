<!DOCTYPE html>
<html lang="fr">
<head>
    {% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/logo_dogsitter.png">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Tarte au citron -->
    <script src="node_modules/tarteaucitronjs/tarteaucitron.js"></script>

    <script>
    tarteaucitron.init({
        highPrivacy: true, // Mode "Consentement fort"
        AcceptAllCta: true,
        DenyAllCta: true,
        privacyUrl: "", // page de politique, à implanter
        orientation: "bottom", // où apparaît la bannière
        showAlertSmall: false, // bannière petite
        cookieslist: true, // liste des cookies
    });

    // Ajouter Google Analytics
    tarteaucitron.user.gajsUa = 'G-F2W0X2M53T'; // Remplace par ton UA ou G-ID
    tarteaucitron.user.gajsMore = function () { 
        /* code additionnel GA si nécessaire */
    };
    tarteaucitron.job = tarteaucitron.job || [];
    tarteaucitron.job.push('gajs');
    </script>


    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: #FEFAE0;
        }

        .required-star {
            color: #d9534f;
            margin-left: 4px;
        }

        .nav-link:hover,
        .nav-link:hover i {
            color: #DDA15E !important;
        }

        /* ===== NOTIFICATIONS ===== */
        .notifications-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .notification {
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            padding: 16px;
            margin-bottom: 12px;
            min-width: 320px;
            max-width: 400px;
            pointer-events: all;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #537031;
        }

        .notification.success {
            border-left-color: #9AAD5A;
        }

        .notification.info {
            border-left-color: #DDA15E;
        }

        .notification.error {
            border-left-color: #d9534f;
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .notification.success .notification-icon {
            background: rgba(154, 173, 90, 0.15);
            color: #9AAD5A;
        }

        .notification.info .notification-icon {
            background: rgba(221, 161, 94, 0.15);
            color: #DDA15E;
        }

        .notification.error .notification-icon {
            background: rgba(217, 83, 79, 0.15);
            color: #d9534f;
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .notification-message {
            font-size: 13px;
            color: #666;
            margin: 0;
            line-height: 1.4;
        }

        .notification-close {
            flex-shrink: 0;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .notification-close:hover {
            color: #999;
        }

        .notification.removing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(30px);
            }
        }
    </style>

    <title>{% block title %}DogSynergie{% endblock %}</title>
    {% endblock %}
</head>

<body class="d-flex flex-column min-vh-100">

<!-- ================= NOTIFICATIONS CONTAINER ================= -->
<div id="notificationsContainer" class="notifications-container"></div>

<!-- ================= USER CONTEXT ================= -->
<script>
    window.userIsConnected = {{ utilisateurConnecte is not null ? 'true' : 'false' }};
    window.userIsMaitre = {{ (utilisateurConnecte is not null and utilisateurConnecte.estMaitre) ? 'true' : 'false' }};
    window.userId = {{ utilisateurConnecte is not null ? utilisateurConnecte.id : 'null' }};
</script>

<!-- ================= HEADER ================= -->
<header class="sticky-top shadow-sm">
    <nav class="navbar navbar-expand-lg" style="background-color:#537031;">
        <div class="container-fluid">

            <!-- Logo -->
            <a class="navbar-brand d-flex align-items-center text-decoration-none"
               href="index.php" style="color:#FEFAE0; font-weight:600;">
                <img src="images/logo_dogsitter.png" height="42" class="me-2" alt="Logo">
                DogSynergie
            </a>

            <!-- Burger -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarDogSitter">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarDogSitter">

                <!-- CENTRE : recherche -->
                <div class="mx-lg-auto my-3 my-lg-0" style="max-width:480px; width:100%;">
                    <form class="d-flex">
                        <input class="form-control rounded-start-pill"
                               placeholder="Rechercher un dog sitter…"
                               style="background:#FEFAE0; border:none;">
                        <button class="btn rounded-end-pill"
                                style="background:#DDA15E; color:white;">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>

                <!-- DROITE : utilisateur -->
                <ul class="navbar-nav ms-lg-auto align-items-lg-center gap-2">
                    {% if utilisateurConnecte is not null %}
                        <li class="nav-item">
                            <a class="nav-link text-light position-relative"
                            href="index.php?controleur=annonce&methode=afficherNotifications"
                            title="Mes notifications">
                                <i class="bi bi-bell fs-5"></i>
                                <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill" style="background-color:#DDA15E; display:none;">
                                    <span id="notificationCount">0</span>
                                </span>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link text-light position-relative"
                            href="index.php?controleur=conversation&methode=afficherMesConversations"
                            title="Mes messages">
                                <i class="bi bi-chat-dots fs-5"></i>
                                <span id="messageBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill" style="background-color:#DDA15E; display:none;">
                                    <span id="messageCount">0</span>
                                </span>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link p-0"
                            href="index.php?controleur=utilisateur&methode=afficherTonUtilisateur">
                            {% if utilisateurConnecte.photoProfil and utilisateurConnecte.photoProfil != '' %}
                                <img src="images/utilisateur/{{ utilisateurConnecte.photoProfil }}" alt="Photo de profil" class="rounded-circle" width="40" height="40" style="object-fit:cover;">
                            {% else %}
                                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background-color: #9AAD5A; border: 2px solid #FEFAE0;">
                                    <i class="bi bi-person" style="font-size: 20px; color: #FEFAE0;"></i>
                                </div>
                            {% endif %}
                            </a>
                        </li>
                    {% else %} 
                        <li class="nav-item"> 
                            <a class="nav-link text-light" href="index.php?controleur=utilisateur&methode=authentification"> 
                                <i class="bi bi-person-circle fs-5">
                                </i> 
                            </a> 
                        </li> 
                    {% endif %}
                </ul>

            </div>
        </div>
    </nav>

    {% block breadcrumb %}
    {% if breadcrumb is defined %}
        <nav class="container-fluid" style="background:#2b3b17;">
            <ol class="breadcrumb m-0 py-2">
                {% for item in breadcrumb %}
                    {% if loop.last %}
                        <li class="breadcrumb-item active text-light">{{ item.title }}</li>
                    {% else %}
                        <li class="breadcrumb-item">
                            <a href="{{ item.url }}" class="text-light text-decoration-none">
                                {{ item.title }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
    {% endif %}
    {% endblock %}
</header>

<!-- ================= MAIN ================= -->
<main class="flex-grow-1">
    {% block content %}{% endblock %}
</main>

<!-- ================= FOOTER ================= -->
<footer class="text-center py-4 mt-auto"
        style="background-color:#537031; color:#FEFAE0;">
    <div class="container">

        <div class="mb-2">
            <a href="index.php" class="text-decoration-none mx-2" style="color:#DDA15E;">
                Accueil
            </a>

            <a href="#" class="text-decoration-none mx-2"
            style="color:#DDA15E;"
            data-bs-toggle="modal"
            data-bs-target="#confidentialiteModal">
                Politique de confidentialité
            </a>

            <a href="#" class="text-decoration-none mx-2"
            style="color:#DDA15E;"
            data-bs-toggle="modal"
            data-bs-target="#cguModal">
                CGU
            </a>

            <a href="index.php?controleur=newsletter&methode=afficher"
            class="text-decoration-none mx-2"
            style="color:#DDA15E;">
                Newsletter
            </a>
        </div>

        <div class="modal fade" id="confidentialiteModal" tabindex="-1" aria-labelledby="confidentialiteLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">

                    <div class="modal-header" style="background-color:#FAF6E9;">
                        <h5 class="modal-title fw-bold" id="confidentialiteLabel"
                            style="color:#537031;">
                            Politique de confidentialité
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body text-dark">

                        <h6 class="fw-bold">1. Données collectées</h6>
                        <p>
                            DogSynergie collecte uniquement les données nécessaires au bon
                            fonctionnement du service (compte utilisateur, mails, annonces).
                        </p>

                        <h6 class="fw-bold">2. Utilisation des données</h6>
                        <p>
                            Les données sont utilisées exclusivement dans le cadre de la
                            mise en relation entre maîtres et promeneurs.
                        </p>

                        <h6 class="fw-bold">3. Conservation</h6>
                        <p>
                            Les données sont conservées tant que le compte est actif.
                        </p>

                        <h6 class="fw-bold">4. Droits de l’utilisateur</h6>
                        <p>
                            Conformément au RGPD, chaque utilisateur dispose d’un droit
                            d’accès, de rectification et de suppression de ses données.
                        </p>
                    </div>

                    <div class="modal-footer">
                        <button class="btn"
                                style="background-color:#537031; color:white;"
                                data-bs-dismiss="modal">
                            Fermer
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div class="modal fade" id="cguModal" tabindex="-1" aria-labelledby="cguLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">

                    <div class="modal-header" style="background-color:#FAF6E9;">
                        <h5 class="modal-title fw-bold" id="cguLabel"
                            style="color:#537031;">
                            Conditions Générales d’Utilisation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body text-dark">

                        <h6 class="fw-bold">1. Objet</h6>
                        <p>
                            Les présentes CGU encadrent l’utilisation de la plateforme
                            DogSynergie, service de mise en relation entre propriétaires
                            de chiens et dog sitters.
                        </p>

                        <h6 class="fw-bold">2. Accès au service</h6>
                        <p>
                            L’accès à la plateforme est gratuit. Certaines fonctionnalités
                            nécessitent la création d’un compte utilisateur.
                        </p>

                        <h6 class="fw-bold">3. Responsabilité</h6>
                        <p>
                            DogSynergie agit en tant qu’intermédiaire et ne saurait être
                            tenu responsable des prestations réalisées entre utilisateurs.
                        </p>

                        <h6 class="fw-bold">4. Compte utilisateur</h6>
                        <p>
                            L’utilisateur s’engage à fournir des informations exactes et
                            à ne pas usurper l’identité d’un tiers.
                        </p>

                        <h6 class="fw-bold">5. Données personnelles</h6>
                        <p>
                            Les données personnelles sont traitées conformément à la
                            politique de confidentialité.
                        </p>

                    </div>

                    <div class="modal-footer">
                        <button class="btn"
                                style="background-color:#537031; color:white;"
                                data-bs-dismiss="modal">
                            Fermer
                        </button>
                    </div>

                </div>
            </div>
        </div>


        <small>
            © Copyright {{ "now"|date("Y") }} - IUT de Bayonne et du Pays Basque - BUT2 Groupe 7
        </small>

    </div>
</footer>

{% block script %}
<!-- Variables globales pour JavaScript -->
<script>
    window.userIsConnected = {{ utilisateurConnecte is not null ? 'true' : 'false' }};
    window.userIsMaitre = {{ (utilisateurConnecte is not null and utilisateurConnecte.estMaitre) ? 'true' : 'false' }};
    window.userId = {{ utilisateurConnecte is not null ? utilisateurConnecte.id : 'null' }};
</script>

<!-- Fichier JavaScript centralisé -->
<script src="js/mescripts.js?v={{ "now"|date("U") }}"></script>

<!-- Fallback dédié pour la pastille messages du header -->
<script>
    (function () {
        if (!window.userIsConnected) return;

        const badge = document.getElementById('messageBadge');
        const countSpan = document.getElementById('messageCount');
        if (!badge || !countSpan) return;

        function refreshMessageBadge() {
            fetch('index.php?controleur=message&methode=getUnreadMessageCount')
                .then(response => response.json())
                .then(data => {
                    const count = (data && data.success) ? (data.count || 0) : 0;
                    if (count > 0) {
                        countSpan.textContent = count > 9 ? '9+' : count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(() => {});
        }

        refreshMessageBadge();
        setInterval(refreshMessageBadge, 10000);
    })();
</script>
{% endblock %}
</body>
</html>

{% extends 'base_template.twig' %}

{% block title %}
    Détails de l'Annonce
{% endblock %}

{% block content %}
    <div style="background-color: #FEFAE0; min-height: 100vh; display: flex; flex-direction: column;">
        <div class="ds-profile-hero">
            <div class="ds-profile-hero-inner">
                <h1 class="ds-profile-hero-title">Détails de l'Annonce</h1>
                <p class="ds-profile-hero-subtitle">Découvrez les détails et les chiens à promener</p>
            </div>
        </div>

        {# Messages de validation - signal pour notifications #}
        {% if reponse == 'ok' %}
            <div id="candidature-success-trigger" data-trigger="1" hidden></div>
        {% endif %}
        
        {% if erreur is defined and erreur %}
            <div style="max-width: 1200px; margin: 30px auto; width: 100%; padding: 0 40px;">
                <div style="background-color: #FAF6E9; border-left: 4px solid #DDA15E; padding: 16px; border-radius: 4px; display: flex; gap: 12px; align-items: flex-start;">
                    <i class="bi bi-exclamation-circle" style="font-size: 24px; color: #DDA15E; flex-shrink: 0; margin-top: 2px;"></i>
                    <div style="color: #537031; margin: 0; font-weight: 500; font-size: 14px;">{{ erreur }}</div>
                </div>
            </div>
        {% endif %}

        <!-- Contenu principal -->
        <div style="flex: 1; padding: 40px; max-width: 1200px; margin: 0 auto; width: 100%;">
            {% if chiens is not empty and annonce is not null %}
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <!-- Sidebar - Chiens -->
                    <aside>
                        <div style="background-color: #FAF6E9; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(83, 112, 49, 0.08);">
                            <h3 style="font-size: 18px; font-weight: 600; color: #537031; margin: 0 0 24px 0; text-transform: uppercase; letter-spacing: 0.5px;">Les Chiens ({{ chiens|length }})</h3>

                            <div style="display: flex; flex-direction: column; gap: 24px;">
                                {% for chien in chiens %}
                                    <div style="text-align: center; padding-bottom: 24px; border-bottom: 1px solid #DDA15E;">
                                        <!-- Photo du chien -->
                                        <div style="width: 120px; height: 120px; margin: 0 auto 16px; border-radius: 12px; overflow: hidden; background-color: #FEFAE0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(83, 112, 49, 0.1);">
                                            {% if chien.getCheminPhoto() %}
                                                <img src="images/chiens/{{ chien.getCheminPhoto() }}" alt="Photo de {{ chien.getNom_Chien() }}" style="width: 100%; height: 100%; object-fit: cover;" />
                                            {% else %}
                                                <i class="bi bi-paw" style="font-size: 48px; color: #9AAD5A;"></i>
                                            {% endif %}
                                        </div>

                                        <!-- Nom du chien -->
                                        <h4 style="font-size: 16px; font-weight: 600; color: #537031; margin: 0 0 12px 0;">{{ chien.getNom_Chien() }}</h4>

                                        <!-- Caractéristiques -->
                                        <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px;">
                                            <div style="background-color: #FEFAE0; padding: 8px 12px; border-radius: 6px; color: #2c2c2c;">
                                                <strong style="color: #537031;">Race :</strong> {{ chien.getRace() }}
                                            </div>
                                            <div style="background-color: #FEFAE0; padding: 8px 12px; border-radius: 6px; color: #2c2c2c;">
                                                <strong style="color: #537031;">Poids :</strong> {{ chien.getPoids() }} kg
                                            </div>
                                            <div style="background-color: #FEFAE0; padding: 8px 12px; border-radius: 6px; color: #2c2c2c;">
                                                <strong style="color: #537031;">Taille :</strong> {{ chien.getTaille() }}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Propriétaire -->
                            <div style="background-color: #FEFAE0; padding: 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px; margin-top: 24px;">
                                {% if proprietaire.photoProfil is not empty %}
                                    <img src="images/utilisateur/{{ proprietaire.photoProfil }}" alt="Photo" width="48" height="48" style="border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                {% else %}
                                    <div style="width: 48px; height: 48px; border-radius: 50%; background-color: #DDA15E; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 20px;">
                                        {{ proprietaire.pseudo|first|upper }}
                                    </div>
                                {% endif %}
                                <div>
                                    <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600; text-transform: uppercase;">Propriétaire</p>
                                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #537031; font-weight: 600;">{{ proprietaire.pseudo|default('Inconnu') }}</p>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <!-- Main content -->
                    <main>
                        <div style="background-color: #FAF6E9; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(83, 112, 49, 0.08);">
                            <!-- Titre principal -->
                            <h2 style="font-size: 28px; font-weight: 600; color: #537031; margin: 0 0 24px 0;">Promenade demandée le {{ annonce.datePromenade }}</h2>

                            <!-- Info principales -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; padding-bottom: 32px; border-bottom: 1px solid #DDA15E;">
                                <div style="background-color: #FEFAE0; padding: 16px; border-radius: 8px;">
                                    <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600; text-transform: uppercase;">Horaire</p>
                                    <p style="margin: 8px 0 0 0; font-size: 18px; color: #537031; font-weight: 600;">{{ annonce.horaire }}</p>
                                </div>
                                <div style="background-color: #FEFAE0; padding: 16px; border-radius: 8px;">
                                    <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600; text-transform: uppercase;">Durée</p>
                                    <p style="margin: 8px 0 0 0; font-size: 18px; color: #537031; font-weight: 600;">{{ annonce.duree }} min</p>
                                </div>
                                <div style="background-color: #FEFAE0; padding: 16px; border-radius: 8px;">
                                    <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600; text-transform: uppercase;">Lieu</p>
                                    <p style="margin: 8px 0 0 0; font-size: 18px; color: #537031; font-weight: 600;"><i class="bi bi-geo-alt" style="margin-right: 6px; color: #9AAD5A;"></i>{{ annonce.endroitPromenade }}</p>
                                </div>
                                <div style="background-color: #FEFAE0; padding: 16px; border-radius: 8px;">
                                    <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600; text-transform: uppercase;">Tarif</p>
                                    <p style="margin: 8px 0 0 0; font-size: 18px; color: #537031; font-weight: 600;">{{ annonce.tarif }}€</p>
                                </div>
                            </div>

                            <!-- Description -->
                            <div style="margin-bottom: 32px;">
                                <h3 style="font-size: 14px; font-weight: 600; color: #537031; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 12px 0;">Description</h3>
                                <div style="background-color: #FEFAE0; padding: 16px; border-radius: 8px; border-left: 4px solid #9AAD5A; font-size: 14px; color: #2c2c2c; line-height: 1.6; white-space: pre-line; overflow-wrap: break-word;">
                                    {{ annonce.description|default('Aucune description fournie par le propriétaire.') | e | nl2br | raw }}
                                </div>
                            </div>

                            <!-- Infos supplémentaires -->
                            <div style="background-color: #FEFAE0; padding: 20px; border-radius: 8px; margin-bottom: 32px;">
                                <h3 style="font-size: 14px; font-weight: 600; color: #537031; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 16px 0;">Informations de Contact</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600;">Téléphone</p>
                                        <p style="margin: 4px 0 0 0; font-size: 14px; color: #537031; font-weight: 500;">
                                            {{ proprietaire.getNumTelephone()|default('Non public') }}
                                        </p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; font-size: 12px; color: #9AAD5A; font-weight: 600;">Adresse</p>
                                        <p style="margin: 4px 0 0 0; font-size: 14px; color: #537031; font-weight: 500;">
                                            {{ proprietaire.getAdresse()|default('Non spécifiée') }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Statut -->
                            <div style="background-color: {% if annonce.status == 'active' %}#E8F5E9{% else %}#FFE8E8{% endif %}; padding: 16px; border-radius: 8px; margin-bottom: 32px; border-left: 4px solid {% if annonce.status == 'active' %}#4CAF50{% else %}#F44336{% endif %};">
                                <p style="margin: 0; font-size: 12px; color: #537031; font-weight: 600; text-transform: uppercase;">Statut de l'annonce</p>
                                <p style="margin: 4px 0 0 0; font-size: 16px; color: #537031; font-weight: 600;">
                                    {% if annonce.status == 'active' %}
                                        <i class="bi bi-check-circle" style="margin-right: 6px; color: #4CAF50;"></i>Disponible
                                    {% else %}
                                        <i class="bi bi-circle-fill" style="margin-right: 6px; color: #F44336;"></i>{{ annonce.status }}
                                    {% endif %}
                                </p>
                            </div>

                            <!-- Boutons d'action -->
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                {% if annonce.getIdUtilisateur() != userConnecte.getId() %}
                                    {% if userConnecte.estPromeneur %}
                                        <a href="?controleur=conversation&methode=creerConversationAvecUtilisateur&id_utilisateur={{ annonce.getIdUtilisateur() }}"
                                            style="flex: 1; min-width: 200px; background-color: #FAF6E9; color: #537031; padding: 14px 20px; font-size: 14px; border: 2px solid #DDA15E; border-radius: 6px; font-weight: 600; text-decoration: none; text-align: center; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.backgroundColor='#F0F8EC'; this.style.borderColor='#537031';" onmouseout="this.style.backgroundColor='#FAF6E9'; this.style.borderColor='#DDA15E';">
                                            <i class="bi bi-chat-dots"></i> Envoyer un message
                                        </a>

                                        {% if annonce.status == 'active' %}
                                            <a href="?controleur=Annonce&methode=repondreAnnonce&id_annonce={{ annonce.getIdAnnonce() }}"
                                                style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #537031 0%, #4a5f28 100%); color: #FEFAE0; padding: 14px 20px; font-size: 14px; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; text-align: center; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(83, 112, 49, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(83, 112, 49, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(83, 112, 49, 0.2)';">
                                                <i class="bi bi-check-circle"></i> Postuler pour l'annonce
                                            </a>
                                        {% else %}
                                            <button style="flex: 1; min-width: 200px; background-color: #ccc; color: white; padding: 14px 20px; font-size: 14px; border: none; border-radius: 6px; font-weight: 600; cursor: not-allowed; opacity: 0.6;">
                                                Statut: {{ annonce.status }}
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <button style="flex: 1; min-width: 200px; background-color: #ccc; color: white; padding: 14px 20px; font-size: 14px; border: none; border-radius: 6px; font-weight: 600; cursor: not-allowed; opacity: 0.6;" disabled>
                                            Seuls les promeneurs peuvent postuler
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <!-- Avis du propriétaire -->
                            <div style="margin-top: 40px; padding-top: 32px; border-top: 2px solid #DDA15E;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                    <h3 style="font-size: 18px; font-weight: 600; color: #537031; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                        <i class="bi bi-star-fill" style="margin-right: 8px; color: #DDA15E;"></i>Avis de cette promenade
                                    </h3>
                                    {% if userConnecte and userConnecte.estMaitre and userConnecte.getId() == proprietaire.getId() %}
                                        {% if acceptedCandidatId %}
                                            <a href="?controleur=Avis&methode=creerAvis&id_utilisateur_note={{ acceptedCandidatId }}&id_annonce={{ annonce.getIdAnnonce() }}"
                                                style="background: linear-gradient(135deg, #537031 0%, #4a5f28 100%); color: #FEFAE0; padding: 10px 16px; font-size: 12px; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; text-align: center; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(83, 112, 49, 0.2); cursor: pointer; white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(83, 112, 49, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(83, 112, 49, 0.2)';">
                                                <i class="bi bi-pencil" style="margin-right: 4px;"></i>Laisser un avis
                                            </a>
                                        {% else %}
                                            <div style="background-color: #FAF6E9; color: #9AAD5A; padding: 10px 16px; font-size: 12px; border: 1px solid #9AAD5A; border-radius: 6px; font-weight: 600; text-align: center; cursor: not-allowed; white-space: nowrap;">
                                                <i class="bi bi-lock" style="margin-right: 4px;"></i>Aucun promeneur accepte
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                {% if avisPromenade is defined and avisPromenade|length > 0 %}
                                    <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                                        {% for avis in avisPromenade %}
                                            <div style="background-color: #FEFAE0; border: 1px solid #9AAD5A; border-radius: 8px; padding: 16px; display: flex; flex-direction: column;">
                                                <!-- Note (étoiles) -->
                                                <div style="display: flex; gap: 4px; margin-bottom: 12px;">
                                                    {% for i in 1..5 %}
                                                        {% if i <= avis.note %}
                                                            <i class="bi bi-star-fill" style="font-size: 16px; color: #DDA15E;"></i>
                                                        {% else %}
                                                            <i class="bi bi-star" style="font-size: 16px; color: #DDA15E; opacity: 0.3;"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                    <span style="margin-left: 6px; font-size: 13px; font-weight: 600; color: #537031;">{{ avis.note }}/5</span>
                                                </div>

                                                <!-- Commentaire -->
                                                {% if avis.getTexteCommentaire() is not empty %}
                                                    <p style="margin: 0; color: #2c2c2c; font-size: 13px; line-height: 1.5; flex: 1;">
                                                        {{ avis.getTexteCommentaire() }}
                                                    </p>
                                                {% else %}
                                                    <p style="margin: 0; color: #9AAD5A; font-size: 13px; font-style: italic;">
                                                        Aucun commentaire
                                                    </p>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div style="background-color: #FEFAE0; border: 1px dashed #9AAD5A; padding: 16px; border-radius: 8px; text-align: center;">
                                        <p style="margin: 0; color: #9AAD5A; font-size: 13px; font-style: italic;">
                                            <i class="bi bi-star" style="margin-right: 6px;"></i>Pas encore d'avis pour cette promenade
                                        </p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </main>
                </div>
            {% else %}
                <div style="background-color: #FAF6E9; border-left: 4px solid #DDA15E; padding: 24px; border-radius: 8px; text-align: center;">
                    <p style="font-size: 16px; color: #537031; margin: 0; font-weight: 600;">
                        <i class="bi bi-exclamation-circle" style="margin-right: 8px; color: #DDA15E;"></i>Les détails de cette annonce sont introuvables
                    </p>
                    <p style="color: #9AAD5A; margin-top: 8px; font-size: 14px;">
                        Veuillez réessayer ou retourner à la liste des annonces.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    {% block footer %}

    {% endblock %}
{% endblock %}
